{% extends 'layout.html.jinja' %}
{% block content %}
<style>
.schedule.weekly-byline {
    grid-template-columns:
        [machine_index] 1fr repeat({{ schedule.frame_size }}, 1fr) [last_col] 1fr [end-col];
    grid-template-rows:
        [weekday_header] .20fr
        {% for machine in schedule.active_machines %}
        [{{ machine }}] 1fr
        {% endfor %}
        [end-row];
}
</style>
<div class="card card-style mb-2 col-md-12 col-lg-12" style="min-width: 992px; max-width: 1680px;">
    <div style="display: inline-flex; width: 100%;">
        <div style="width: 50%;">
            <h3 class="card-title">Pouching</h3>
        </div>
        <div class="h3-sub-right" style="width: 50%;  min-width: fit-content; margin-top: 25px; text-align: right;">
            <a href="/schedule/{{ schedule.prior_week }}">
                <div class="h3-sub-right arrows">
                    < </div>
            </a>
            <div class="h3-sub-right arrows">{{ schedule }}</div>
            <a href="/schedule/{{ schedule.next_week }}">
                <div class="h3-sub-right arrows"> > </div>
            </a>
        </div>
    </div>
    <div class="card-body main-block" style="display: inline-flex;">

        <!-- SCHEDULE -->
        <div class="schedule weekly-byline">
            <!--  PREVIOUS WEEK ARROWS  -->
            <a href="/schedule/{{ schedule.prior_week }}">
                <div class="corner">
                    << </div>
            </a>
            <!--  WEEKDAY HEADERS  -->
            {% for day in schedule.dates %}
            <div class="weekday_header {{ day.strftime('%a').lower() }}">
                <div>{{ day.strftime('%a') }}</div>
                <div style="font-size: 90%">{{ day.strftime('%b %d') }}</div>
            </div>
            {% endfor %}

            <!-- FOLLOWING WEEK ARROWS -->
            <a href="/schedule/{{ schedule.next_week }}">
                <div class="corner">
                    >> </div>
            </a>

            <!--  PRODUCTION LINES  -->
            {% set col_offset = 2 %}
            {% for machine in schedule.active_machines %}
            <div class="machine_index {{ machine }}">{{ machine }}</div>

            <!-- HOURS OF THE WEEK-->
            {% for hour in range(48 * 7) %}
            {% set col_num = hour + col_offset %}

            {# This block allocates CSS classes #}
            {# to each hour based on conditionals. #}
            <div class="hour 
                        {% if schedule.schedule_type == 'current' %}
                            {% if hour == schedule.current_week_hour %}
                                current_hour 
                            {% endif %}
                            {% if hour < schedule.current_week_hour %}
                                elapsed 
                            {% endif %}
                        {% elif schedule.schedule_type == 'past' %}
                            elapsed
                        {% endif %}

                        {% if not schedule.index_[hour] %}
                            not-scheduled
                        {% endif %}

                        {% if hour % 24 == 0 %}
                            start_of_day
                        {% endif %}

                        {% if hour % 24 == 12 %}
                            midday 
                        {% endif %}

                        {% if hour == 167 %}
                            last_hour
                        {% endif %}" style="grid-row: {{ machine }}; grid-column: {{ col_num }}"
                ondragover="onDragOver(event);" ondrop="onDrop(event);">
            </div>
            {% endfor %}
            {% endfor %}

            <!-- WORK ORDERS -->
            {% for work_order in schedule.work_orders %}
            {% if work_order.start_datetime < schedule.start_datetime and work_order.end_datetime > schedule.end_datetime %}
                <!-- WORK ORDERS THAT SPAN THE CURRENT WEEK -->
                {% set start_col = col_offset %}
                {% set end_col = 168 + col_offset %}
                <div id="sched_{{ work_order.lot_number }}" style="grid-column-start: {{ start_col }};
                            grid-column-end: {{ end_col }}; grid-row: line_{{ work_order.line }};">
                    <a href="/view-work-order/{{ work_order.lot_number }}">
                        <li class="work_order {{ work_order.product }} week_span" style="grid-column-start: {{ start_col }}; grid-column-end: {{ end_col }};
                                    grid-row: line_{{ work_order.line }};">
                            {{ work_order.short_name }} {{ work_order.lot_id }}
                        </li>
                    </a>
                </div>
                {% elif work_order.start_datetime < schedule.start_datetime %}
                <!-- WORK ORDERS THAT STARTED THE PREVIOUS WEEK -->
                    {% set start_col = col_offset %}
                    {% set end_col = (work_order.end_datetime.weekday() * 24 + work_order.end_datetime.hour +
                    col_offset) %}
                    <div id="sched_{{ work_order.lot_number }}" style="grid-column-start: {{ start_col }};
                            grid-column-end: {{ end_col }}; grid-row: line_{{ work_order.line }};">
                        <a href="/view-work-order/{{ work_order.lot_number }}">
                            <li class="work_order {{ work_order.product }} week_start" style="grid-column-start: {{ start_col }}; grid-column-end: {{ end_col }};
                                    grid-row: line_{{ work_order.line }};">
                                {{ work_order.short_name }} {{ work_order.lot_id }}
                            </li>
                        </a>
                    </div>
                {% elif work_order.end_datetime > schedule.end_datetime %}
                <!-- WORK ORDERS THAT WILL END THE FOLLOWING WEEK -->
                    {% set start_col = (work_order.start_datetime.weekday() * 24 + work_order.start_datetime.hour +
                    col_offset) %}
                    {% set end_col = 168 + col_offset %}
                    <div id="sched_{{ work_order.lot_number }}" style="grid-column-start: {{ start_col }};
                            grid-column-end: {{ end_col }}; grid-row: line_{{ work_order.line }};">
                        <a href="/view-work-order/{{ work_order.lot_number }}">
                            <li class="work_order {{ work_order.product }} week_end" style="grid-column-start: {{ start_col }}; grid-column-end: {{ end_col }};
                                    grid-row: line_{{ work_order.line }};">
                                {{ work_order.short_name }} {{ work_order.lot_id }}
                            </li>
                        </a>
                    </div>
                {% else %}
                <!-- WORK ORDERS -->
                    {% set start_col = (work_order.start_datetime.weekday() * 24 + work_order.start_datetime.hour +
                    col_offset) %}
                    {% set end_col = (work_order.end_datetime.weekday() * 24 + work_order.end_datetime.hour +
                    col_offset) %}
                    <div id="sched_{{ work_order.lot_number }}" style="grid-column-start: {{ start_col }};
                            grid-column-end: {{ end_col }}; grid-row: line_{{ work_order.line }};">
                        <a href="/view-work-order/{{ work_order.lot_number }}">
                            <li class="work_order {{ work_order.product }}" style="grid-column-start: {{ start_col }}; grid-column-end: {{ end_col }};
                                    grid-row: line_{{ work_order.line }};">
                                {{ work_order.short_name }} {{ work_order.lot_id }}
                            </li>
                        </a>
                    </div>
                    {% endif %}
                    {% endfor %}
        </div>

        <!-- PARKING LOT -->
        <div class="col parking-lot-column">
            <div class="parking_lot_header">Parking Lot</div>

            <div class="parking_lot">
                <a href="/add-work-order">
                    <div class="add" id="add_work_order">
                        +
                    </div>
                </a>
                {% for work_order in schedule.parking_lot() %}
                <a href="/view-work-order/{{ work_order.lot_number }}">
                    <div class="work_order {{ work_order.product }}" id="{{ work_order.lot_number }}" draggable="true"
                        ondragstart="onDragStart(event);" onclick="onClick(event);">
                        {{ work_order.short_name }} {{ work_order.lot_id }}
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="/static/schedule.js"></script>

{% endblock %}